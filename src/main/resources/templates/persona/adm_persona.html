<div id="main-wrapper">
    <div class="container-fluid mw-100">
        <div class="row">
            <div class="card">
                <div class="border-bottom title-part-padding">
                    <h4 class="card-title mb-0">Datos Persona</h4>
                </div>
                <div class="card-body">
                    <form action="/registrarPersona" method="post">
                        <div class="form-group col-md-2 mb-3">
                            <label for="codigo_funcionario">Codigo Funcionario</label>
                            <input type="text" class="form-control" name="codigo_funcionario" id="codigo_funcionario"
                                placeholder="Codigo Funcionario" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Registrar Persona</button>
                    </form>

                </div>
            </div>

            <div class="datatables">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-2">
                                    <h5 class="mb-0">Registros</h5>
                                </div>
                                <p class="card-subtitle mb-3">
                                    Datos de los estudiantes vigentes
                                </p>
                                <div class="table-responsive">
                                    <table id="data-table"
                                        class="table border w-100 table-striped table-bordered display text-nowrap"
                                        style="font-size: 12px">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Nombres</th>
                                                <th>Apellido Parteno</th>
                                                <th>Apellido Materno</th>
                                                <th>C.I</th>
                                                <th>Codigo Funcionario</th>
                                                <th>Opciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="per, index : ${personas}">
                                                <td th:text="${index.index+1}"></td>
                                                <td th:text="${per.nombre}"></td>
                                                <td th:text="${per.paterno}"></td>
                                                <td th:text="${per.materno}"></td>
                                                <td th:text="${per.ci}"></td>
                                                <td th:text="${per.codigo_funcionario}"></td>
                                                <td class="text-center">
                                                    <div class="btn-group">
                                                        <a class="btn btn-info me-2" type="button"
                                                            style="color: aliceblue;"
                                                            th:attr="onclick='editarPersona(' + ${per.idPersona} + ')'">
                                                            <li class="fa fa-edit"></li>
                                                        </a>
                                                        <a class="btn btn-danger" type="button"
                                                            style="color: aliceblue;"
                                                            th:attr="onclick='eliminarPersona(\'' + ${per.idPersona} + '\', \'' + ${per.nombre}+'\')'">
                                                            <li class="fa-solid fa-trash"></li>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        $('#data-table').DataTable({
            dom: 'Bfrtip',  // Integra botones en la tabla
            buttons: [
                'copy', 'csv', 'excel', 'pdf', 'print'  // Habilita los botones de exportación
            ]
        });
    });

    $('#personaForm').submit(function (event) {
        event.preventDefault();  // Evitar el envío del formulario normal

        var formData = $(this).serialize();  // Serializar el formulario
        $.ajax({
            url: '/registrarPersona',  // Ruta que apunta al controlador de registro
            type: 'POST',
            data: formData,
            success: function (response) {
                Swal.fire(
                    '¡Guardado!',
                    'Registro guardado correctamente.',
                    'success'
                );
                limpiarFormulario();
                actualizarTabla();  // Actualizar la tabla de personas
            },
            error: function (xhr, status, error) {
                Swal.fire(
                    'Error',
                    'Hubo un problema al guardar el registro.',
                    'error'
                );
            }
        });
    });

    function limpiarFormulario() {
        $('#personaForm')[0].reset();  // Restablecer todos los campos del formulario
    }

    function actualizarTabla() {
        $.ajax({
            url: '/vista_persona',  // Ruta para obtener la vista actualizada de la tabla
            type: 'GET',
            success: function (response) {
                // Actualizar solo el cuerpo de la tabla con los nuevos datos
                var tablaPersonas = $(response).find('#file_export tbody').html();
                $('#file_export tbody').html(tablaPersonas);
            },
            error: function (xhr, status, error) {
                console.error('Error al actualizar la tabla: ', error);
            }
        });
    }

    function editarPersona(idPersona) {
        $.ajax({
            url: '/persona/' + idPersona,
            type: 'GET',
            success: function (persona) {
                $('#idPersona').val(persona.idPersona);
                $('#nombre').val(persona.nombre);
                $('#apellidoP').val(persona.paterno);
                $('#apellidoM').val(persona.materno);
                $('#ci').val(persona.ci);
                $('#rd').val(persona.codigo_funcionario);
            },
            error: function () {
                alert('Error al obtener los datos de la persona.');
            }
        });
    }

    function eliminarPersona(idPersona) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "¡No podrás recuperar este registro!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminarlo!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: 'POST',
                    url: '/eliminar-persona/' + idPersona,

                    success: function (response) {
                        Swal.fire(
                            'Eliminado!',
                            'El registro ha sido eliminado.',
                            'success'
                        );
                    },
                    error: function (xhr, status, error) {
                        Swal.fire(
                            'Error!',
                            'No se pudo eliminar el registro.',
                            'error'
                        );
                        console.error(error);
                    }
                });
            }
        });
    }
</script>